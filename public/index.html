<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Goal Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen">
  <div class="max-w-md mx-auto p-4 space-y-6">
    <h1 class="text-2xl font-bold text-center mb-4">Daily Goal Tracker</h1>

    <!-- Googleログイン -->
    <div class="flex justify-center">
      <button id="loginBtn" class="bg-red-500 text-white px-4 py-2 rounded">Googleでログイン</button>
      <button id="logoutBtn" class="hidden bg-gray-500 text-white px-4 py-2 rounded">ログアウト</button>
    </div>

    <!-- 日次セクション -->
    <section class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">今日の目標金額</h2>
      <div class="flex space-x-2 mb-2">
        <input id="goalInput" type="number" placeholder="例: 10000"
               class="flex-1 border rounded px-2 py-1 text-right">
        <button id="setGoalBtn" class="bg-green-600 text-white px-4 rounded">設定</button>
      </div>
      <p id="goalDisplay" class="text-sm text-gray-600">未設定</p>
    </section>

    <section class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">現在の合計</h2>
      <p class="text-3xl font-bold text-gray-900" id="totalDisplay">¥0</p>
      <p class="text-sm text-gray-600" id="progressDisplay">達成率: 0%</p>
      <div class="w-full bg-gray-200 h-2 rounded">
        <div id="progressBar" class="bg-green-600 h-2 rounded w-0"></div>
      </div>
    </section>

    <!-- Amazonクイック加算 -->
    <section class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">Amazon（＋137円/タップ）</h2>
      <p class="text-sm text-gray-600 mb-2">配達個数: <span id="amazonCount">0</span> 回</p>
      <div class="flex space-x-2 mb-2">
        <button class="bg-indigo-600 text-white px-3 py-1 rounded" id="addAmazonBtn">+137円</button>
        <input id="amazonMultiplier" type="number" min="1" max="100" placeholder="×個数"
               class="w-20 border rounded px-2 py-1 text-center">
      </div>
    </section>

    <!-- 手動入力 -->
    <section class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">フードデリバリー（手動入力）</h2>
      <div class="flex space-x-2">
        <input id="fdInput" type="number" placeholder="金額（円）を入力"
               class="flex-1 border rounded px-2 py-1 text-right">
        <button id="fdAddBtn" class="bg-sky-600 text-white px-4 rounded">追加</button>
      </div>
    </section>

    <!-- リセット -->
    <section class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">1日の締め</h2>
      <button id="resetBtn" class="bg-red-500 text-white w-full py-2 rounded">本日のデータをリセット</button>
    </section>

    <!-- 月次 -->
    <section class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">月次レポート</h2>
      <div class="flex flex-col space-y-2">
        <button id="exportCsvBtn" class="bg-yellow-500 text-white py-2 rounded">CSVを出力</button>
        <button id="exportPdfCloudBtn" class="bg-indigo-600 text-white py-2 rounded">PDFを出力（クラウド）</button>
      </div>
    </section>

  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-functions.js";

    // ---- Firebase設定 ----
    const firebaseConfig = {
      apiKey: "AIzaSyDwt4EL1tLDehbGvluSf3-SNRKfvbzjQaU",
      authDomain: "daily-goal-tracker-900c0.firebaseapp.com",
      projectId: "daily-goal-tracker-900c0",
      storageBucket: "daily-goal-tracker-900c0.firebasestorage.app",
      messagingSenderId: "1022566470001",
      appId: "1:1022566470001:web:10c7a2db8d938beb53e6d0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, "asia-northeast1");

    // ---- 状態管理 ----
    let currentUser = null;
    let goal = 0;
    let total = 0;
    let amazonCount = 0;

    // ---- ログイン / ログアウト ----
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      document.getElementById("loginBtn").classList.toggle("hidden", !!user);
      document.getElementById("logoutBtn").classList.toggle("hidden", !user);
      if (user) {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) {
          const data = snap.data();
          goal = data.goal || 0;
          total = data.total || 0;
          amazonCount = data.amazonCount || 0;
          updateUI();
        }
      }
    });

    // ---- UI更新 ----
    function updateUI() {
      document.getElementById("goalDisplay").textContent = goal ? `目標: ¥${goal.toLocaleString()}` : "未設定";
      document.getElementById("totalDisplay").textContent = `¥${total.toLocaleString()}`;
      const pct = goal > 0 ? Math.min(Math.floor((total / goal) * 100), 100) : 0;
      document.getElementById("progressDisplay").textContent = `達成率: ${pct}%`;
      document.getElementById("progressBar").style.width = `${pct}%`;
      document.getElementById("amazonCount").textContent = amazonCount;
    }

    async function saveState() {
      if (!currentUser) return;
      await setDoc(doc(db, "users", currentUser.uid), { goal, total, amazonCount });
    }

    // ---- 操作イベント ----
    document.getElementById("setGoalBtn").addEventListener("click", async () => {
      const input = document.getElementById("goalInput").value;
      goal = Number(input) || 0;
      await saveState();
      updateUI();
    });

    document.getElementById("addAmazonBtn").addEventListener("click", async () => {
      const multiplier = Number(document.getElementById("amazonMultiplier").value) || 1;
      total += 137 * multiplier;
      amazonCount += multiplier;
      await saveState();
      updateUI();
    });

    document.getElementById("fdAddBtn").addEventListener("click", async () => {
      const val = Number(document.getElementById("fdInput").value);
      if (!val) return;
      total += val;
      document.getElementById("fdInput").value = "";
      await saveState();
      updateUI();
    });

    document.getElementById("resetBtn").addEventListener("click", async () => {
      total = 0;
      amazonCount = 0;
      await saveState();
      updateUI();
    });

    // ---- PDF出力（クラウド） ----
    document.getElementById("exportPdfCloudBtn")?.addEventListener("click", async () => {
      if (!currentUser) { alert("PDF（クラウド生成）はログインが必要です。"); return; }
      try {
        const payload = {
          monthId: new Date().toISOString().slice(0, 7),
          monthGoal: goal,
          monthTotal: total,
          rows: [
            { day: new Date().toISOString().slice(0,10), goal, total, pct: goal ? Math.floor(total / goal * 100) : 0 }
          ],
        };

        const callable = httpsCallable(functions, "generateMonthlyPdf");
        const res = await callable(payload);
        const { base64, filename } = res.data || {};
        if (!base64) throw new Error("サーバーからPDFデータを受信できませんでした。");

        const dataUrl = `data:application/pdf;base64,${base64}`;
        const popup = window.open(dataUrl, "_blank");

        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = filename || `DailyGoalTracker_${payload.monthId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        if (!popup) console.log("Popup blocked; used download fallback.");
      } catch (e) {
        console.error(e);
        alert(e?.message || "PDF生成に失敗しました。");
      }
    });
  </script>
</body>
</html>
